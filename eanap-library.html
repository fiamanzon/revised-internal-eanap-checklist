<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EANAP Compliance Files</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #003366;
            padding-bottom: 20px;
        }

        .header h1 {
            color: #003366;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-style: italic;
        }

        .navigation {
            margin-bottom: 30px;
            text-align: center;
        }

        .nav-btn {
            padding: 10px 20px;
            background: #003366;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: #004488;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #003366 0%, #004488 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .checklist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .checklist-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
        }

        .checklist-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }

        .checklist-card h3 {
            color: #003366;
            font-size: 18px;
            margin-bottom: 10px;
            border-bottom: 2px solid #003366;
            padding-bottom: 10px;
        }

        .checklist-card .info {
            color: #666;
            font-size: 14px;
            margin: 8px 0;
        }

        .checklist-card .info strong {
            color: #333;
        }

        .checklist-card .actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s;
            flex: 1;
        }

        .btn-primary {
            background: #003366;
            color: white;
        }

        .btn-primary:hover {
            background: #004488;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            margin: 30px auto;
            padding: 30px;
            border-radius: 8px;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #666;
        }

        .close:hover {
            color: #000;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section h3 {
            color: #003366;
            border-bottom: 2px solid #003366;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        table th {
            background: #003366;
            color: white;
            padding: 10px;
            text-align: left;
            font-size: 14px;
        }

        table td {
            padding: 10px;
            border: 1px solid #ddd;
        }

        table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .signature-display {
            max-width: 200px;
            max-height: 80px;
            border: 1px solid #ddd;
            margin: 5px 0;
        }

        .photo-preview {
            max-width: 100px;
            max-height: 100px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-results h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .navigation, .filters, .close, .actions, .btn {
                display: none !important;
            }
            
            .modal {
                display: block !important;
                position: relative;
                background: white;
            }
            
            .modal-content {
                margin: 0;
                padding: 20px;
                max-width: 100%;
                box-shadow: none;
            }
        }

        @media (max-width: 768px) {
            .checklist-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>EANAP Compliance Files</h1>
            <p>Archive of Completed Checklists</p>
        </div>

        <div class="navigation">
            <a href="eanap-compliance-checklist.html" class="nav-btn">‚Üê Back to Checklist Form</a>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label>Search by Event Name:</label>
                <input type="text" id="searchInput" placeholder="Type to search...">
            </div>
            <div class="filter-group">
                <label>Filter by Venue:</label>
                <select id="venueFilter">
                    <option value="">All Venues</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Filter by Month:</label>
                <select id="monthFilter">
                    <option value="">All Months</option>
                    <option value="01">January</option>
                    <option value="02">February</option>
                    <option value="03">March</option>
                    <option value="04">April</option>
                    <option value="05">May</option>
                    <option value="06">June</option>
                    <option value="07">July</option>
                    <option value="08">August</option>
                    <option value="09">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Filter by Year:</label>
                <select id="yearFilter">
                    <option value="">All Years</option>
                </select>
            </div>
        </div>

        <div class="checklist-grid" id="checklistsGrid"></div>
    </div>

    <!-- View Modal -->
    <div id="viewModal" class="modal">
        <div class="modal-content" id="modalContent">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="viewContent"></div>
            <div class="actions" style="margin-top: 30px; text-align: center;">
                <button class="btn btn-success" onclick="exportToPDF()">Export to PDF</button>
                <button class="btn btn-danger" onclick="deleteCurrentChecklist()">Delete Checklist</button>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <span class="close" onclick="closePhotoModal()">&times;</span>
            <img id="photoModalImage" style="max-width: 90%; max-height: 90%;" src="" alt="Photo">
        </div>
    </div>

    <script>
        let currentChecklistId = null;
        let allChecklists = [];

        // Format date for display
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            const day = String(date.getDate()).padStart(2, '0');
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            return `${day}${month}${year}`;
        }

        // Generate checklist name
        function generateChecklistName(checklist) {
            const venue = checklist.venue.replace(/\s+/g, '_').toUpperCase();
            const date = formatDate(checklist.eventDate);
            return `${venue}_${date}`;
        }

        // Load all checklists
        function loadChecklists() {
            allChecklists = JSON.parse(localStorage.getItem('eanapChecklists') || '[]');
            
            // Sort by date (newest first)
            allChecklists.sort((a, b) => new Date(b.eventDate) - new Date(a.eventDate));
            
            populateFilters();
            displayChecklists();
        }

        // Populate filter dropdowns
        function populateFilters() {
            // Populate venues
            const venues = [...new Set(allChecklists.map(c => c.venue))].sort();
            const venueFilter = document.getElementById('venueFilter');
            venueFilter.innerHTML = '<option value="">All Venues</option>';
            venues.forEach(venue => {
                venueFilter.innerHTML += `<option value="${venue}">${venue}</option>`;
            });

            // Populate years
            const years = [...new Set(allChecklists.map(c => new Date(c.eventDate).getFullYear()))].sort((a, b) => b - a);
            const yearFilter = document.getElementById('yearFilter');
            yearFilter.innerHTML = '<option value="">All Years</option>';
            years.forEach(year => {
                yearFilter.innerHTML += `<option value="${year}">${year}</option>`;
            });
        }

        // Display checklists
        function displayChecklists() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const venueFilter = document.getElementById('venueFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;

            const filtered = allChecklists.filter(checklist => {
                const matchesSearch = checklist.eventName.toLowerCase().includes(searchTerm);
                const matchesVenue = !venueFilter || checklist.venue === venueFilter;
                const date = new Date(checklist.eventDate);
                const matchesMonth = !monthFilter || String(date.getMonth() + 1).padStart(2, '0') === monthFilter;
                const matchesYear = !yearFilter || date.getFullYear() == yearFilter;

                return matchesSearch && matchesVenue && matchesMonth && matchesYear;
            });

            const grid = document.getElementById('checklistsGrid');
            
            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="no-results" style="grid-column: 1/-1;">
                        <h3>No Checklists Found</h3>
                        <p>Try adjusting your filters or search terms</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map(checklist => {
                const checklistName = generateChecklistName(checklist);
                const date = new Date(checklist.eventDate);
                const formattedDate = date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });

                return `
                    <div class="checklist-card" onclick="viewChecklist(${checklist.id})">
                        <h3>${checklistName}</h3>
                        <div class="info"><strong>Event:</strong> ${checklist.eventName}</div>
                        <div class="info"><strong>Date:</strong> ${formattedDate}</div>
                        <div class="info"><strong>Venue:</strong> ${checklist.venue}</div>
                        <div class="info"><strong>Setup Time:</strong> ${checklist.setupTime || 'N/A'}</div>
                        <div class="info"><strong>Saved:</strong> ${new Date(checklist.timestamp).toLocaleString()}</div>
                        <div class="actions" onclick="event.stopPropagation()">
                            <button class="btn btn-primary" onclick="viewChecklist(${checklist.id})">View Details</button>
                            <button class="btn btn-success" onclick="exportChecklistToPDF(${checklist.id})">Export PDF</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // View checklist details
        function viewChecklist(id) {
            const checklist = allChecklists.find(c => c.id === id);
            if (!checklist) return;

            currentChecklistId = id;
            const checklistName = generateChecklistName(checklist);

            let html = `
                <h2>${checklistName}</h2>
                
                <div class="detail-section">
                    <h3>Event Information</h3>
                    <table>
                        <tr>
                            <td><strong>Event Name:</strong></td>
                            <td>${checklist.eventName}</td>
                        </tr>
                        <tr>
                            <td><strong>Date:</strong></td>
                            <td>${new Date(checklist.eventDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</td>
                        </tr>
                        <tr>
                            <td><strong>Venue:</strong></td>
                            <td>${checklist.venue}</td>
                        </tr>
                        <tr>
                            <td><strong>Setup Start Time:</strong></td>
                            <td>${checklist.setupTime}</td>
                        </tr>
                    </table>
                </div>

                <div class="detail-section">
                    <h3>Contractors/Suppliers</h3>
                    ${checklist.contractors.length > 0 ? `
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Service Type</th>
                                    <th>EANAP Provided</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${checklist.contractors.map(c => `
                                    <tr>
                                        <td>${c.name}</td>
                                        <td>${c.serviceType}</td>
                                        <td>${c.eanapProvided}</td>
                                        <td>${c.notes || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<p>No contractors recorded.</p>'}
                </div>

                <div class="detail-section">
                    <h3>Monitoring Schedule</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Setup Stage</th>
                                <th>Time</th>
                                <th>Checked By</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${checklist.monitoring.map(m => `
                                <tr>
                                    <td>${m.stage}</td>
                                    <td>${m.time || '-'}</td>
                                    <td>${m.checkedBy || '-'}</td>
                                    <td>${m.remarks || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <div class="detail-section">
                    <h3>Compliance Status</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>EANAP Section</th>
                                <th>Status</th>
                                <th>Issues Identified</th>
                                <th>Action Taken</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${checklist.compliance.map(c => `
                                <tr>
                                    <td>${c.section}</td>
                                    <td><strong>${c.status || 'N/A'}</strong></td>
                                    <td>${c.issues || '-'}</td>
                                    <td>${c.action || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <div class="detail-section">
                    <h3>Escalation Log</h3>
                    ${checklist.escalation.length > 0 ? `
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Contractor</th>
                                    <th>Issue Description</th>
                                    <th>Corrective Action</th>
                                    <th>Resolved</th>
                                    <th>Photos</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${checklist.escalation.map(e => `
                                    <tr>
                                        <td>${e.time}</td>
                                        <td>${e.contractor}</td>
                                        <td>${e.issue}</td>
                                        <td>${e.action}</td>
                                        <td>${e.resolved}</td>
                                        <td>
                                            ${e.photos && e.photos.length > 0 ? 
                                                e.photos.map(photo => `<img src="${photo}" class="photo-preview" onclick="viewPhoto('${photo}')">`).join('') 
                                                : '-'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<p>No escalation issues recorded.</p>'}
                </div>

                <div class="detail-section">
                    <h3>Personnel Sign-Off</h3>
                    <table>
                        <tr>
                            <td><strong>Banquet Setup/GY in charge:</strong></td>
                            <td>${checklist.signatures.setupGY.name || 'Not signed'}</td>
                            <td>${checklist.signatures.setupGY.dateTime ? new Date(checklist.signatures.setupGY.dateTime).toLocaleString() : ''}</td>
                            <td>${checklist.signatures.setupGY.signature ? `<img src="${checklist.signatures.setupGY.signature}" class="signature-display">` : ''}</td>
                        </tr>
                        <tr>
                            <td><strong>Banquet Event In Charge:</strong></td>
                            <td>${checklist.signatures.eventInCharge.name || 'Not signed'}</td>
                            <td>${checklist.signatures.eventInCharge.dateTime ? new Date(checklist.signatures.eventInCharge.dateTime).toLocaleString() : ''}</td>
                            <td>${checklist.signatures.eventInCharge.signature ? `<img src="${checklist.signatures.eventInCharge.signature}" class="signature-display">` : ''}</td>
                        </tr>
                        <tr>
                            <td><strong>Security In-Charge:</strong></td>
                            <td>${checklist.signatures.security.name || 'Not signed'}</td>
                            <td>${checklist.signatures.security.dateTime ? new Date(checklist.signatures.security.dateTime).toLocaleString() : ''}</td>
                            <td>${checklist.signatures.security.signature ? `<img src="${checklist.signatures.security.signature}" class="signature-display">` : ''}</td>
                        </tr>
                    </table>
                </div>

                <div class="detail-section">
                    <h3>Management Cross-Verification</h3>
                    <table>
                        <tr>
                            <td><strong>BQT Manager In Charge:</strong></td>
                            <td>${checklist.management.bqt.name || 'Not signed'}</td>
                            <td>${checklist.management.bqt.dateTime ? new Date(checklist.management.bqt.dateTime).toLocaleString() : ''}</td>
                            <td>${checklist.management.bqt.signature ? `<img src="${checklist.management.bqt.signature}" class="signature-display">` : ''}</td>
                        </tr>
                        <tr>
                            <td><strong>FLS/Engineering In Charge:</strong></td>
                            <td>${checklist.management.fls.name || 'Not signed'}</td>
                            <td>${checklist.management.fls.dateTime ? new Date(checklist.management.fls.dateTime).toLocaleString() : ''}</td>
                            <td>${checklist.management.fls.signature ? `<img src="${checklist.management.fls.signature}" class="signature-display">` : ''}</td>
                        </tr>
                    </table>
                </div>
            `;

            document.getElementById('viewContent').innerHTML = html;
            document.getElementById('viewModal').style.display = 'block';
        }

        // Close modal
        function closeModal() {
            document.getElementById('viewModal').style.display = 'none';
            currentChecklistId = null;
        }

        // View photo
        function viewPhoto(photoData) {
            document.getElementById('photoModalImage').src = photoData;
            document.getElementById('photoModal').style.display = 'block';
        }

        // Close photo modal
        function closePhotoModal() {
            document.getElementById('photoModal').style.display = 'none';
        }

        // Export to PDF
        function exportToPDF() {
            if (!currentChecklistId) return;
            
            const checklist = allChecklists.find(c => c.id === currentChecklistId);
            const checklistName = generateChecklistName(checklist);
            
            // Use browser's print functionality
            const originalTitle = document.title;
            document.title = checklistName;
            window.print();
            document.title = originalTitle;
        }

        // Export specific checklist to PDF
        function exportChecklistToPDF(id) {
            event.stopPropagation();
            viewChecklist(id);
            setTimeout(() => {
                exportToPDF();
            }, 500);
        }

        // Delete current checklist
        function deleteCurrentChecklist() {
            if (!currentChecklistId) return;
            
            const checklist = allChecklists.find(c => c.id === currentChecklistId);
            const checklistName = generateChecklistName(checklist);
            
            if (!confirm(`Are you sure you want to delete "${checklistName}"? This action cannot be undone.`)) {
                return;
            }
            
            let checklists = JSON.parse(localStorage.getItem('eanapChecklists') || '[]');
            checklists = checklists.filter(c => c.id !== currentChecklistId);
            localStorage.setItem('eanapChecklists', JSON.stringify(checklists));
            
            closeModal();
            loadChecklists();
            alert('Checklist deleted successfully.');
        }

        // Add event listeners
        document.getElementById('searchInput').addEventListener('input', displayChecklists);
        document.getElementById('venueFilter').addEventListener('change', displayChecklists);
        document.getElementById('monthFilter').addEventListener('change', displayChecklists);
        document.getElementById('yearFilter').addEventListener('change', displayChecklists);

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        };

        // Initialize
        loadChecklists();
    </script>
</body>
</html>